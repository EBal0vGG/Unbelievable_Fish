## 1. Общая идея первого этапа (рамка)

**Цель этапа 1**

**Работающий скелет платформы**, который:

* показывает логику торгов (аукцион / фикс);
* имеет пользователей, роли, сделки;
* легко расширяется;
* не блокирует будущее подключение блокчейна, логистики и т.п.

Поэтому:

* микросервисы;

* блокчейн, логистика, склады, снабжение — **заглушки**;

---

## 2. Примерная структура проекта

### 2.1. Логическая архитектура

```
[ Frontend (Web) ]
        |
[ API Gateway ]
        |
----------------------------------
| User / Auth Service            |
| Trading (Auctions / Deals)     |
| Catalog (Products)             |
| Reputation                     |
| Notifications                  |
----------------------------------
        |
[ Infrastructure ]
(DB, Message Bus, Files, Cache)
```


---

### 2.2. Организация репозитория


```
/apps
  /frontend-web
  /api

/packages
  /contracts        // DTO, OpenAPI, события
  /ui-kit           // общие UI-компоненты
  /domain           // бизнес-логика

/infra
  /docker
  /migrations
  /local-env

/docs
  architecture.md
  decisions.md
```

---

## 3. Составляющие приложения

### 3.1. Пользователи и роли (MVP)

**User / Company / Role**

* регистрация компании;
* пользователь привязан к компании;
* роли: продавец / покупатель / админ;

---

### 3.2. Каталог товаров

**Product / Lot**

* карточка товара;
* фото;
* статус (черновик / опубликован / продан);
* привязка к продавцу.

---

### 3.3. Торги (ядро)

Поддержать **2 режима**:

* фиксированная цена;
* простой аукцион.

Без:

* автоставок;
* сложных расписаний;
* закрытых торгов.

Но архитектурно:

* тип торгов = стратегия;
* ставки = события.

---

### 3.4. Сделка (Deal)

* победитель торгов;
* фиксация условий сделки;
* статусная модель (created → confirmed → completed).

Здесь **вставляется абстракция блокчейна**:

```
DealConfirmed → ContractRegistry.register(deal)
```

Где `ContractRegistry` — интерфейс, а реализация пока заглушка.

---

### 3.5. Репутация

* +1 успешная сделка;
* хранение отзывов;
* расчет рейтинга — простая формула.

---

### 3.6. Уведомления

* внутренняя система событий;
* email / push — заглушки;
* UI-уведомления в кабинете.

---

## 4. Стек

### Backend / API

* PostgreSQL
* OpenAPI как контракт
* ...

### Frontend

* ...

### Общие вещи

* Docker Compose
* ...

---

<!-- ## 5. Декомпозиция ролей

### Разработчик 1 — **Core Domain / Trading**

Ответственность:

* модель торгов;
* ставки;
* сделки;
* бизнес-правила.

Задачи:

* domain-модели (Auction, Bid, Deal);
* API для торгов;
* события (BidPlaced, AuctionClosed);
* юнит-тесты бизнес-логики.

---

### Разработчик 2 — **Users / Catalog / Reputation**

Ответственность:

* пользователи и компании;
* каталог товаров;
* рейтинги.

Задачи:

* User / Company модели;
* Product / Lot CRUD;
* простой рейтинг;
* админские действия (минимум).

---

### Разработчик 3 — **Frontend + Integration**

Ответственность:

* UI;
* интеграция API;
* пользовательские сценарии.

Задачи:

* личный кабинет;
* список торгов;
* карточка товара;
* участие в торгах;
* уведомления в UI.

--- -->

## 5. Роли в команде (условно)

Назовем их не по технологиям, а по зонам ответственности:

1. Core / Trading
2. Commercial / Entities
3. Platform / Integration

---

## 5.1. Распределение обязанностей

## Разработчик A — Core / Trading (ядро бизнеса)

### Отвечает за:

* Trading Domain (аукционы, ставки);
* бизнес-правила торгов;
* state machines;
* генерацию событий.

### Конкретные задачи:

* модель Auction, Bid;
* FSM аукциона;
* правила валидации ставок;
* события:

  * BidPlaced
  * AuctionClosed;
* API:

  * создать аукцион;
  * сделать ставку;
  * закрыть аукцион.

Не отвечает:

* за пользователей;
* за UI;
* за платежи.

---

## Разработчик B — Commercial / Entities (что продаем и кто продает)

### Отвечает за:

* Catalog Domain;
* Identity (в рамках нужд бизнеса);
* компании, товары, лоты;
* первичную репутацию.

### Конкретные задачи:

* Company, User, Role;
* Product, Lot;
* публикация товара;
* базовый рейтинг;
* API:

  * регистрация компании;
  * создание товара;
  * публикация лота.

Не отвечает:

* за механику торгов;
* за инфраструктуру.

---

## Разработчик C — Platform / Integration (система как целое)

### Отвечает за:

* Deal Domain;
* события между доменами;
* абстракции блокчейна;
* уведомления;
* архитектурную связность.

### Конкретные задачи:

* Deal, Contract;
* порт ContractRegistry;
* обработка AuctionClosed;
* event bus (in-memory / broker);
* Notification Domain (заглушка);
* API:

  * подтверждение сделки;
  * история сделок.

Не отвечает:

* за логику торгов;
* за модели товаров.

---

## 5.2. Зоны совместной ответственности (очень важно)

## 5.2.1. Контракты и события — общее

* DTO;
* события;
* OpenAPI;
* naming.

Любое изменение через короткое обсуждение, иначе рассыпется система.

---

## 5.2.2. Domain boundaries — священны

Правило:

> чужой домен можно использовать, но нельзя менять

---

## 5.3. Как они работают вместе (практика)

### Пример: пользователь участвует в аукционе

1. B: создает компанию, товар, лот
2. A: публикует аукцион
3. A: принимает ставки
4. A: закрывает аукцион → AuctionClosed
5. C: ловит событие → создает Deal
6. C: подтверждает сделку
7. C: дергает ContractRegistry
8. B: обновляет репутацию по событию

---

## 5.4. Что каждый делает в первую неделю

### Разработчик A

* FSM аукциона;
* модель ставок;
* юнит-тесты бизнес-правил.

### Разработчик B

* модель пользователей и компаний;
* модель товара / лота;
* связи между ними.

### Разработчик C

* event bus;
* модель сделки;
* порт блокчейна;
* схема взаимодействия доменов.

—-

## 6. Шкала сложности (чтобы мы говорили на одном языке)

## 6.1. Оценка по разработчикам

## Разработчик A — Core / Trading

### Общий уровень сложности: 5 / 5

#### Почему:

* Core domain проекта;
* максимальное количество бизнес-правил;
* state machine;
* гонки состояний (ставки);
* любые ошибки → недоверие к платформе.

### По подзадачам:

| Задача            | Сложность |
| ----------------- | --------- |
| FSM аукциона      | 5         |
| Логика ставок     | 5         |
| Закрытие аукциона | 4         |
| Генерация событий | 4         |
| API торгов        | 4         |

### Риски:

* race conditions;
* неявные бизнес-правила;
* сложность изменения логики в будущем.

---

## Разработчик B — Commercial / Entities

### Общий уровень сложности: 3 / 5

#### Почему:

* много сущностей;
* относительно простые правила;
* высокая связность с UI;
* минимум алгоритмики.

### По подзадачам:

| Задача            | Сложность |
| ----------------- | --------- |
| Users / Companies | 3         |
| Products / Lots   | 3         |
| Публикация        | 2         |
| Репутация (v1)    | 2         |
| CRUD API          | 2         |

### Риски:

* расползание моделей;
* утечка логики в контроллеры;
* «анемичная» модель.

---

## Разработчик C — Platform / Integration

### Общий уровень сложности: 4 / 5

#### Почему:

* склейка всей системы;
* события;
* асинхронность;
* абстракции (блокчейн, уведомления);
* ошибки проявляются не сразу.

### По подзадачам:

| Задача                     | Сложность |
| -------------------------- | --------- |
| Deal Domain                | 3         |
| Event Bus                  | 4         |
| Междоменное взаимодействие | 4         |
| Blockchain Port            | 3         |
| Notifications              | 2         |

### Риски:

* tight coupling;
* неконтролируемые сайд-эффекты;
* сложность отладки.

---

# 6.2. Рекомендации по снижению риска

### Для A (5/5)

* максимальное покрытие юнит-тестами;
* явная FSM (не if-else);
* запрет прямых side-effects.

### Для B (3/5)

* строгие aggregate boundaries;
* никакой логики в контроллерах;
* ревью naming’а.

### Для C (4/5)

* логирование событий;
* идемпотентность;
* минимальный event bus (без overengineering).

---

## 7. План первого этапа

### Шаг 1 — Архитектурная договоренность

* утвердить домены;
* утвердить структуру репозитория;
* описать контракты (OpenAPI черновик);

---

### Шаг 2 — Скелет системы

* auth (минимум);
* пустые модули;
* фронт с роутингом;
* CI / Docker.

---

### Шаг 3 — Торги + каталог (основа)

* создание лота;
* участие в торгах;
* завершение аукциона;
* фиксация сделки;
* отображение в UI.

---

### Шаг 4 — Полировка MVP

* базовые уведомления;
* рейтинги;
* стабилизация API;
* документация.



## 8. Домены


## 8.1. Core Domain

### Trading Domain

**Сердце платформы**

Отвечает за:

* аукционы;
* ставки;
* определение победителя;
* переход в сделку.

---

## 8.2. Supporting Domains (поддержка core)

### Catalog Domain

* товары;
* лоты;
* характеристики;
* публикация / скрытие.

> Каталог не решает, *кто выиграл торги* — он только описывает товар.

---

### Deal / Contract Domain

* фиксация условий сделки;
* статусы исполнения;
* связь с блокчейном (через порт).

> Торги **заканчиваются**, а сделки **начинаются**.

---

### Reputation Domain

* отзывы;
* рейтинги;
* расчеты доверия.

> Репутация **никогда** не влияет напрямую на результат торгов
> (иначе будет коррупция в логике).

---

### Notification Domain

* подписки;
* уведомления;
* каналы доставки.

---

## 8.3. Generic / Infrastructure Domains

### Identity & Access

* пользователи;
* компании;
* роли;
* права.

---

### Payment / Wallet

* деньги;
* блокировки;
* расчеты.

---

### Blockchain Gateway

* не бизнес-логика;
* только фиксация фактов.

---

### Logistics / Warehouse / Docs

* **заглушки**;
* только интерфейсы.

---

## 8.4. Domain Map

```
 ┌─────────────────────┐
 │ Identity & Access   │
 └─────────┬───────────┘
           │
 ┌─────────▼───────────┐
 │ Catalog             │
 └─────────┬───────────┘
           │
 ┌─────────▼───────────┐
 │ Trading (CORE)      │
 │ - Auctions          │
 │ - Bids              │
 └─────────┬───────────┘
           │ AuctionClosed
 ┌─────────▼───────────┐
 │ Deal / Contract     │
 │ - Deal              │
 │ - Obligations       │
 └─────────┬───────────┘
           │ DealConfirmed
 ┌─────────▼───────────┐
 │ Blockchain Gateway  │
 └─────────────────────┘

   ▲                ▲
   │                │
 Reputation     Notifications
```

---

## 9. Event-модель

### 9.1. Ключевые события

#### Trading Domain

* `AuctionCreated`
* `AuctionPublished`
* `BidPlaced`
* `AuctionClosed`

#### Deal Domain

* `DealCreated`
* `DealConfirmed`
* `DealCompleted`
* `DealFailed`

#### Reputation Domain

* `ReputationUpdated`

---

### 9.2. Пример потока событий

```
AuctionClosed
   ↓
DealCreated
   ↓
DealConfirmed
   ↓
BlockchainRegistered
   ↓
ReputationUpdated
   ↓
NotificationSent
```

---

## 10. Состояния аукциона (FSM)

### Auction State Machine

```
DRAFT
  │
  ▼
PUBLISHED
  │
  ├── BidPlaced
  │
  ▼
CLOSED
  │
  ├── no bids → CANCELLED
  │
  └── has bids
        ▼
     WON
```

### Ограничения:

* ставки принимаются **только** в `PUBLISHED`;
* победитель определяется **один раз**;
* повторное закрытие невозможно.

---

## 11. Состояния сделки

```
CREATED
  │
  ▼
CONFIRMED
  │
  ├── success → COMPLETED
  │
  └── fail → FAILED
```

