## 1. Общая идея первого этапа (рамка)

**Цель этапа 1**

**Работающий скелет платформы**, который:

* показывает логику торгов (аукцион / фикс);
* имеет пользователей, роли, сделки;
* легко расширяется;
* не блокирует будущее подключение блокчейна, логистики и т.п.

Поэтому:

* микросервисы;

* блокчейн, логистика, склады, снабжение — **заглушки**;

---

## 2. Примерная структура проекта

### 2.1. Логическая архитектура

```
[ Frontend (Web) ]
        |
[ API Gateway ]
        |
----------------------------------
| User / Auth Service            |
| Trading (Auctions / Deals)     |
| Catalog (Products)             |
| Reputation                     |
| Notifications                  |
----------------------------------
        |
[ Infrastructure ]
(DB, Message Bus, Files, Cache)
```


---

### 2.2. Организация репозитория


```
/apps
  /frontend-web
  /api

/packages
  /contracts        // DTO, OpenAPI, события
  /ui-kit           // общие UI-компоненты
  /domain           // бизнес-логика

/infra
  /docker
  /migrations
  /local-env

/docs
  architecture.md
  decisions.md
```

---

## 3. Составляющие приложения

### 3.1. Пользователи и роли (MVP)

**User / Company / Role**

* регистрация компании;
* пользователь привязан к компании;
* роли: продавец / покупатель / админ;

---

### 3.2. Каталог товаров

**Product / Lot**

* карточка товара;
* фото;
* статус (черновик / опубликован / продан);
* привязка к продавцу.

---

### 3.3. Торги (ядро)

Поддержать **2 режима**:

* фиксированная цена;
* простой аукцион.

Без:

* автоставок;
* сложных расписаний;
* закрытых торгов.

Но архитектурно:

* тип торгов = стратегия;
* ставки = события.

---

### 3.4. Сделка (Deal)

* победитель торгов;
* фиксация условий сделки;
* статусная модель (created → confirmed → completed).

Здесь **вставляется абстракция блокчейна**:

```
DealConfirmed → ContractRegistry.register(deal)
```

Где `ContractRegistry` — интерфейс, а реализация пока заглушка.

---

### 3.5. Репутация

* +1 успешная сделка;
* хранение отзывов;
* расчет рейтинга — простая формула.

---

### 3.6. Уведомления

* внутренняя система событий;
* email / push — заглушки;
* UI-уведомления в кабинете.

---

## 4. Стек

### Backend / API

* PostgreSQL
* OpenAPI как контракт
* ...

### Frontend

* ...

### Общие вещи

* Docker Compose
* ...

---

## 5. Декомпозиция ролей

### Разработчик 1 — **Core Domain / Trading**

Ответственность:

* модель торгов;
* ставки;
* сделки;
* бизнес-правила.

Задачи:

* domain-модели (Auction, Bid, Deal);
* API для торгов;
* события (BidPlaced, AuctionClosed);
* юнит-тесты бизнес-логики.

---

### Разработчик 2 — **Users / Catalog / Reputation**

Ответственность:

* пользователи и компании;
* каталог товаров;
* рейтинги.

Задачи:

* User / Company модели;
* Product / Lot CRUD;
* простой рейтинг;
* админские действия (минимум).

---

### Разработчик 3 — **Frontend + Integration**

Ответственность:

* UI;
* интеграция API;
* пользовательские сценарии.

Задачи:

* личный кабинет;
* список торгов;
* карточка товара;
* участие в торгах;
* уведомления в UI.

---

## 6. План первого этапа

### Шаг 1 — Архитектурная договоренность

* утвердить домены;
* утвердить структуру репозитория;
* описать контракты (OpenAPI черновик);

---

### Шаг 2 — Скелет системы

* auth (минимум);
* пустые модули;
* фронт с роутингом;
* CI / Docker.

---

### Шаг 3 — Торги + каталог (основа)

* создание лота;
* участие в торгах;
* завершение аукциона;
* фиксация сделки;
* отображение в UI.

---

### Шаг 4 — Полировка MVP

* базовые уведомления;
* рейтинги;
* стабилизация API;
* документация.



## 7. Домены


## 7.1. Core Domain

### Trading Domain

**Сердце платформы**

Отвечает за:

* аукционы;
* ставки;
* определение победителя;
* переход в сделку.

---

## 7.2. Supporting Domains (поддержка core)

### Catalog Domain

* товары;
* лоты;
* характеристики;
* публикация / скрытие.

> Каталог не решает, *кто выиграл торги* — он только описывает товар.

---

### Deal / Contract Domain

* фиксация условий сделки;
* статусы исполнения;
* связь с блокчейном (через порт).

> Торги **заканчиваются**, а сделки **начинаются**.

---

### Reputation Domain

* отзывы;
* рейтинги;
* расчеты доверия.

> Репутация **никогда** не влияет напрямую на результат торгов
> (иначе будет коррупция в логике).

---

### Notification Domain

* подписки;
* уведомления;
* каналы доставки.

---

## 7.3. Generic / Infrastructure Domains

### Identity & Access

* пользователи;
* компании;
* роли;
* права.

---

### Payment / Wallet

* деньги;
* блокировки;
* расчеты.

---

### Blockchain Gateway

* не бизнес-логика;
* только фиксация фактов.

---

### Logistics / Warehouse / Docs

* **заглушки**;
* только интерфейсы.

---

## 3. Domain Map

```
 ┌─────────────────────┐
 │ Identity & Access   │
 └─────────┬───────────┘
           │
 ┌─────────▼───────────┐
 │ Catalog             │
 └─────────┬───────────┘
           │
 ┌─────────▼───────────┐
 │ Trading (CORE)      │
 │ - Auctions          │
 │ - Bids              │
 └─────────┬───────────┘
           │ AuctionClosed
 ┌─────────▼───────────┐
 │ Deal / Contract     │
 │ - Deal              │
 │ - Obligations       │
 └─────────┬───────────┘
           │ DealConfirmed
 ┌─────────▼───────────┐
 │ Blockchain Gateway  │
 └─────────────────────┘

   ▲                ▲
   │                │
 Reputation     Notifications
```

---

## 8. Event-модель

### 8.1. Ключевые события

#### Trading Domain

* `AuctionCreated`
* `AuctionPublished`
* `BidPlaced`
* `AuctionClosed`

#### Deal Domain

* `DealCreated`
* `DealConfirmed`
* `DealCompleted`
* `DealFailed`

#### Reputation Domain

* `ReputationUpdated`

---

### 8.2. Пример потока событий

```
AuctionClosed
   ↓
DealCreated
   ↓
DealConfirmed
   ↓
BlockchainRegistered
   ↓
ReputationUpdated
   ↓
NotificationSent
```

---

## 9. Состояния аукциона (FSM)

### Auction State Machine

```
DRAFT
  │
  ▼
PUBLISHED
  │
  ├── BidPlaced
  │
  ▼
CLOSED
  │
  ├── no bids → CANCELLED
  │
  └── has bids
        ▼
     WON
```

### Ограничения:

* ставки принимаются **только** в `PUBLISHED`;
* победитель определяется **один раз**;
* повторное закрытие невозможно.

---

## 10. Состояния сделки

```
CREATED
  │
  ▼
CONFIRMED
  │
  ├── success → COMPLETED
  │
  └── fail → FAILED
```

